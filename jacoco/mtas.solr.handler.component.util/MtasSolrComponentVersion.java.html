<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MtasSolrComponentVersion.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MTAS</a> &gt; <a href="index.source.html" class="el_package">mtas.solr.handler.component.util</a> &gt; <span class="el_source">MtasSolrComponentVersion.java</span></div><h1>MtasSolrComponentVersion.java</h1><pre class="source lang-java linenums">package mtas.solr.handler.component.util;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.jar.Attributes;
import java.util.jar.Manifest;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.common.util.SimpleOrderedMap;
import org.apache.solr.handler.component.ResponseBuilder;
import org.apache.solr.handler.component.SearchComponent;
import org.apache.solr.handler.component.ShardRequest;
import org.apache.solr.handler.component.ShardResponse;

import mtas.codec.util.CodecComponent.ComponentFields;
import mtas.codec.util.CodecComponent.ComponentVersion;
import mtas.solr.handler.component.MtasSolrSearchComponent;

// TODO: Auto-generated Javadoc
/**
 * The Class MtasSolrComponentStatus.
 */
public class MtasSolrComponentVersion implements MtasSolrComponent&lt;ComponentVersion&gt; {

	/** The Constant log. */
<span class="fc" id="L31">	private static final Log log = LogFactory.getLog(MtasSolrComponentVersion.class);</span>

	/** The search component. */
	MtasSolrSearchComponent searchComponent;

<span class="fc" id="L36">	String propertyVersion = null;</span>

<span class="fc" id="L38">	String propertyArtifactId = null;</span>

<span class="fc" id="L40">	String propertyGroupId = null;</span>

<span class="fc" id="L42">	String propertyTimestamp = null;</span>

	/** The Constant NAME. */
	public static final String NAME = &quot;version&quot;;

	/** The Constant PARAM_MTAS_VERSION. */
	public static final String PARAM_MTAS_VERSION = MtasSolrSearchComponent.PARAM_MTAS + &quot;.&quot; + NAME;

	public static final String NAME_MTAS_VERSION_VERSION = &quot;version&quot;;

	public static final String NAME_MTAS_VERSION_GROUPID = &quot;groupId&quot;;

	public static final String NAME_MTAS_VERSION_ARTIFACTID = &quot;artifactId&quot;;

	public static final String NAME_MTAS_VERSION_TIMESTAMP = &quot;timestamp&quot;;

	public static final String NAME_MTAS_VERSION_SHARDS = &quot;shards&quot;;

<span class="fc" id="L60">	public static final String NAME_MTAS_VERSION_SHARD = &quot;shard&quot;;</span>

	/**
	 * Instantiates a new mtas solr component status.
	 *
	 * @param searchComponent
	 *            the search component
	 */
<span class="fc" id="L68">	public MtasSolrComponentVersion(MtasSolrSearchComponent searchComponent) {</span>
<span class="fc" id="L69">		this.searchComponent = searchComponent;</span>
		// get classPath
<span class="fc" id="L71">		Class&lt;MtasSolrComponentVersion&gt; clazz = MtasSolrComponentVersion.class;</span>
<span class="fc" id="L72">		String className = clazz.getSimpleName() + &quot;.class&quot;;</span>
<span class="fc" id="L73">		String classPath = clazz.getResource(className).toString();</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">		if (classPath.startsWith(&quot;jar&quot;)) {</span>
<span class="nc" id="L75">			String manifestPath = classPath.substring(0, classPath.lastIndexOf(&quot;!&quot;) + 1) + &quot;/META-INF/MANIFEST.MF&quot;;</span>
			try {
<span class="nc" id="L77">				Manifest manifest = new Manifest(new URL(manifestPath).openStream());</span>
<span class="nc" id="L78">				Attributes attr = manifest.getMainAttributes();</span>
<span class="nc" id="L79">				propertyVersion = attr.getValue(&quot;Specification-version&quot;);</span>
<span class="nc" id="L80">				propertyArtifactId = attr.getValue(&quot;Specification-artifactId&quot;);</span>
<span class="nc" id="L81">				propertyGroupId = attr.getValue(&quot;Specification-groupId&quot;);</span>
<span class="nc" id="L82">				propertyTimestamp = attr.getValue(&quot;Specification-timestamp&quot;);</span>
<span class="nc" id="L83">			} catch (MalformedURLException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L85">				e.printStackTrace();</span>
<span class="nc" id="L86">			} catch (IOException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L88">				e.printStackTrace();</span>
			}
		}
<span class="fc" id="L91">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * mtas.solr.handler.component.util.MtasSolrComponent#prepare(org.apache.solr.
	 * handler.component.ResponseBuilder,
	 * mtas.codec.util.CodecComponent.ComponentFields)
	 */
	@Override
	public void prepare(ResponseBuilder rb, ComponentFields mtasFields) throws IOException {
<span class="nc" id="L103">		mtasFields.doVersion = true;</span>
<span class="nc" id="L104">		mtasFields.version = new ComponentVersion();</span>
<span class="nc" id="L105">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * mtas.solr.handler.component.util.MtasSolrComponent#create(mtas.codec.util.
	 * CodecComponent.BasicComponent, java.lang.Boolean)
	 */
	@Override
	public SimpleOrderedMap&lt;Object&gt; create(ComponentVersion version, Boolean encode) throws IOException {
<span class="nc" id="L116">		return getVersion();</span>
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * mtas.solr.handler.component.util.MtasSolrComponent#modifyRequest(org.apache
	 * .solr.handler.component.ResponseBuilder,
	 * org.apache.solr.handler.component.SearchComponent,
	 * org.apache.solr.handler.component.ShardRequest)
	 */
	@Override
	public void modifyRequest(ResponseBuilder rb, SearchComponent who, ShardRequest sreq) {
		// do nothing
<span class="nc" id="L131">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * mtas.solr.handler.component.util.MtasSolrComponent#finishStage(org.apache.
	 * solr.handler.component.ResponseBuilder)
	 */
	@Override
	public void finishStage(ResponseBuilder rb) {
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (rb.req.getParams().getBool(MtasSolrSearchComponent.PARAM_MTAS, false)) {</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">			if (rb.stage &gt;= ResponseBuilder.STAGE_EXECUTE_QUERY &amp;&amp; rb.stage &lt; ResponseBuilder.STAGE_GET_FIELDS) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">				for (ShardRequest sreq : rb.finished) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">					if (sreq.params.getBool(MtasSolrSearchComponent.PARAM_MTAS, false)</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">							&amp;&amp; sreq.params.getBool(PARAM_MTAS_VERSION, false)) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">						for (ShardResponse shardResponse : sreq.responses) {</span>
<span class="nc" id="L148">							NamedList&lt;Object&gt; solrShardResponse = shardResponse.getSolrResponse().getResponse();</span>
							try {
<span class="nc" id="L150">								SimpleOrderedMap&lt;Object&gt; data = (SimpleOrderedMap&lt;Object&gt;) solrShardResponse</span>
<span class="nc" id="L151">										.findRecursive(MtasSolrSearchComponent.NAME, NAME);</span>
								// create shardInfo
<span class="nc" id="L153">								SimpleOrderedMap&lt;Object&gt; dataShard = new SimpleOrderedMap&lt;&gt;();</span>
<span class="nc" id="L154">								dataShard.add(NAME_MTAS_VERSION_SHARD, shardResponse.getShard());</span>
<span class="nc" id="L155">								dataShard.add(NAME, data.clone());</span>
<span class="nc" id="L156">								List&lt;SimpleOrderedMap&gt; dataShards = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L157">								dataShards.add(dataShard);</span>
								// create main data
<span class="nc" id="L159">								data.clear();</span>
<span class="nc" id="L160">								data.addAll(getVersion());</span>
								// add shardInfo
<span class="nc" id="L162">								data.add(NAME_MTAS_VERSION_SHARDS, dataShards);</span>
<span class="nc" id="L163">							} catch (ClassCastException | IOException e) {</span>
<span class="nc" id="L164">								log.debug(e);</span>
								// shouldn't happen
							}

						}
					}
				}

			}
		}

<span class="nc" id="L175">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * mtas.solr.handler.component.util.MtasSolrComponent#distributedProcess(org.
	 * apache.solr.handler.component.ResponseBuilder,
	 * mtas.codec.util.CodecComponent.ComponentFields)
	 */
	@Override
	public void distributedProcess(ResponseBuilder rb, ComponentFields mtasFields) throws IOException {
		// TODO Auto-generated method stub

<span class="nc" id="L189">	}</span>

	private SimpleOrderedMap&lt;Object&gt; getVersion() throws IOException {
<span class="nc" id="L192">		SimpleOrderedMap&lt;Object&gt; mtasVersionResponse = new SimpleOrderedMap&lt;&gt;();</span>
<span class="nc" id="L193">		mtasVersionResponse.add(NAME_MTAS_VERSION_GROUPID, propertyGroupId);</span>
<span class="nc" id="L194">		mtasVersionResponse.add(NAME_MTAS_VERSION_ARTIFACTID, propertyArtifactId);</span>
<span class="nc" id="L195">		mtasVersionResponse.add(NAME_MTAS_VERSION_VERSION, propertyVersion);</span>
<span class="nc" id="L196">		mtasVersionResponse.add(NAME_MTAS_VERSION_TIMESTAMP, propertyTimestamp);</span>
<span class="nc" id="L197">		return mtasVersionResponse;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>